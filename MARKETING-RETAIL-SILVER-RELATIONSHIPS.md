# Marketing-Retail Silver Layer - Relationships Now Visible

## What Was Fixed

Added `key_fields` arrays to all 8 banking-specific Silver Layer tables so the relationship detection function can identify foreign key relationships.

## Banking-Specific Table Relationships

### 1. Campaign → Product Relationship
**From**: `silver.mktg_campaigns_enriched`  
**To**: Product Master (referenced via product_sku)  
**Key**: `product_sku` (FK)  
**Business Meaning**: Campaigns target specific banking products (e.g., PREMIUM_CHECKING_001)

### 2. Campaign → Offer Relationship
**From**: `silver.mktg_campaigns_enriched`  
**To**: Offer Master (referenced via offer_id)  
**Key**: `offer_id` (FK)  
**Business Meaning**: Campaigns may include promotional offers ($200 bonus, 0% APR)

### 3. Lead → Campaign Relationship
**From**: `silver.mktg_leads_enriched`  
**To**: `silver.mktg_campaigns_enriched`  
**Key**: `campaign_id` (FK)  
**Business Meaning**: Leads are generated by marketing campaigns

**Visual**:
```
┌──────────────────────────────┐
│ mktg_campaigns_enriched      │
│ ─────────────────────────    │
│ • campaign_id (PK)           │
│ • product_sku (FK)           │
│ • offer_id (FK)              │
│ • tcpa_compliant             │
│ • cfpb_reviewed              │
└──────────────────────────────┘
            ▲
            │ campaign_id
            │
┌──────────────────────────────┐
│ mktg_leads_enriched          │
│ ─────────────────────────    │
│ • lead_id (PK)               │
│ • customer_id (FK)           │
│ • campaign_id (FK) ────────┐ │
│ • product_sku_interest (FK)  │
│ • offer_id (FK)              │
│ • lead_score                 │
│ • credit_score_range         │
└──────────────────────────────┘
```

### 4. Lead → Customer Relationship
**From**: `silver.mktg_leads_enriched`  
**To**: Customer Master (via customer_id)  
**Key**: `customer_id` (FK)  
**Business Meaning**: Leads are matched to existing customers (for cross-sell) or prospects

### 5. Lead → Offer Relationship
**From**: `silver.mktg_leads_enriched`  
**To**: Offer Master  
**Key**: `offer_id` (FK)  
**Business Meaning**: Leads may be associated with specific offers

### 6. Lead → Consent Relationship
**From**: `silver.mktg_leads_enriched`  
**To**: `silver.mktg_consent_current`  
**Key**: `customer_id` (FK)  
**Business Meaning**: Lead contact must respect customer consent preferences (TCPA compliance)

**Visual**:
```
┌──────────────────────────────┐
│ mktg_leads_enriched          │
│ ─────────────────────────    │
│ • lead_id (PK)               │
│ • customer_id (FK) ────────┐ │
│ • campaign_id (FK)           │
│ • marketing_consent_email    │
│ • marketing_consent_phone    │
│ • marketing_consent_sms      │
└──────────────────────────────┘
            │ customer_id
            ▼
┌──────────────────────────────┐
│ mktg_consent_current         │
│ ─────────────────────────    │
│ • customer_id (PK)           │
│ • email_opt_in               │
│ • sms_opt_in                 │
│ • phone_opt_in               │
│ • tcpa_consent               │
│ • can_spam_consent           │
│ • gdpr_consent               │
└──────────────────────────────┘
```

### 7. Journey → Lead Relationship
**From**: `silver.mktg_customer_journeys`  
**To**: `silver.mktg_leads_enriched`  
**Key**: `lead_id` (FK)  
**Business Meaning**: Journeys track lead progression from awareness to conversion

### 8. Journey → Campaign Relationship
**From**: `silver.mktg_customer_journeys`  
**To**: `silver.mktg_campaigns_enriched`  
**Key**: `campaign_id` (FK)  
**Business Meaning**: Journeys originate from campaigns

### 9. Journey → Customer Relationship
**From**: `silver.mktg_customer_journeys`  
**To**: Customer Master  
**Key**: `customer_id` (FK)  
**Business Meaning**: Journeys track customer touchpoints

**Visual**:
```
┌──────────────────────────────┐
│ mktg_customer_journeys       │
│ ─────────────────────────    │
│ • journey_id (PK)            │
│ • customer_id (FK) ─��──────┐ │
│ • lead_id (FK) ──────────┐   │
│ • campaign_id (FK) ────┐     │
│ • branch_visit_count       │ │
│ • call_center_count        │ │
└──────────────────────────────┘
            │               │   │
            │               │   └─▶ Customer Master
            │               │
            │               └─────▶ mktg_leads_enriched
            │
            └───────────────────▶ mktg_campaigns_enriched
```

### 10. Attribution → Journey Relationship
**From**: `silver.mktg_multi_touch_attribution`  
**To**: `silver.mktg_customer_journeys`  
**Key**: `journey_id` (FK)  
**Business Meaning**: Attribution breaks down journey touchpoint credit

### 11. Attribution → Campaign Relationship
**From**: `silver.mktg_multi_touch_attribution`  
**To**: `silver.mktg_campaigns_enriched`  
**Key**: `campaign_id` (FK)  
**Business Meaning**: Attribution tracks campaign contribution

### 12. Attribution → Customer Relationship
**From**: `silver.mktg_multi_touch_attribution`  
**To**: Customer Master  
**Key**: `customer_id` (FK)  
**Business Meaning**: Attribution is customer-specific

**Visual**:
```
┌──────────────────────────────┐
│ mktg_multi_touch_attribution │
│ ─────────────────────────    │
│ • attribution_id (PK)        │
│ • customer_id (FK) ────────┐ │
│ • journey_id (FK) ───────┐   │
│ • campaign_id (FK) ────┐     │
│ • attribution_model          │
│ • branch_attribution_credit  │
│ • branch_attribution_revenue │
└──────────────────────────────┘
            │            │   │
            │            │   └─▶ Customer Master
            │            │
            │            └─────▶ mktg_customer_journeys
            │
            └──────────────────▶ mktg_campaigns_enriched
```

### 13. Campaign Performance → Campaign Relationship
**From**: `silver.mktg_campaign_performance_daily`  
**To**: `silver.mktg_campaigns_enriched`  
**Key**: `campaign_id` (FK)  
**Business Meaning**: Daily performance metrics roll up to campaigns

**Visual**:
```
┌──────────────────────��───────┐
│ mktg_campaigns_enriched      │
│ ─────────────────────────    │
│ • campaign_id (PK)           │
│ • target_accounts_opened     │
│ • budget_total               │
└──────────────────────────────┘
            ▲
            │ campaign_id
            │
┌──────────────────────────────┐
│ mktg_campaign_performance_   │
│ daily                        │
│ ─────────────────────────    │
│ • campaign_id (FK) ────────┐ │
│ • date                       │
│ • accounts_opened            │
│ • accounts_funded            │
│ • total_deposits_acquired    │
│ • cac                        │
└──────────────────────────────┘
```

### 14. Offer Performance → Offer Relationship
**From**: `silver.mktg_offer_performance`  
**To**: Offer Master  
**Key**: `offer_id` (FK)  
**Business Meaning**: Performance tracking for promotional offers

### 15. Offer Performance → Campaign Relationship
**From**: `silver.mktg_offer_performance`  
**To**: `silver.mktg_campaigns_enriched`  
**Key**: `campaign_id` (FK)  
**Business Meaning**: Offers are promoted through campaigns

**Visual**:
```
┌──────────────────────────────┐
│ mktg_offer_performance       │
│ ─────────────────────────    │
│ • offer_id (FK) ────────────┐│
│ • campaign_id (FK) ───────┐  │
│ • redemption_rate            │
│ • bonus_payout_rate          │
│ • early_closure_rate         │
│ • offer_roi                  │
└──────────────────────────────┘
            │              │
            │              └──▶ Offer Master
            │
            └─────────────────▶ mktg_campaigns_enriched
```

## Complete Relationship Map

### Star Pattern - Campaign as Central Hub
```
                    Offer Master
                         ▲
                         │ offer_id
                         │
┌────────────────────────────────────────────���────────┐
│         mktg_campaigns_enriched (CENTRAL)           │
│         ────────────────────────────────            │
│         • campaign_id (PK)                          │
│         • product_sku (FK to Product)               │
│         • offer_id (FK to Offer)                    │
│         • compliance_approved                       │
└─────────────────────────────────────────────────────┘
       ▲              ▲              ▲              ▲
       │              │              │              │
   campaign_id    campaign_id    campaign_id    campaign_id
       │              │              │              │
       │              │              │              │
┌─────────┐  ┌──────────────┐  ┌────────────┐  ┌────────────┐
│ Leads   │  │ Journeys     │  │ Attribution│  │ Performance│
│         │  │              │  │            │  │            │
│ Enriched│  │              │  │            │  │ Daily      │
└─────────┘  └──────────────┘  └────────────┘  └────────────┘
```

### Chain Pattern - Lead to Attribution Flow
```
Campaign
  │
  ├─▶ Lead (generated)
  │     │
  │     ├─▶ Customer (matched)
  │     │
  │     └─▶ Journey (tracked)
  │           │
  │           ├─▶ Touchpoints (branch, email, SMS)
  │           │
  │           └─▶ Attribution (credit assignment)
  │                 │
  │                 └─▶ Revenue (attributed)
  │
  └─▶ Performance (daily metrics)
        │
        └─▶ ROI (calculated)
```

### Compliance Flow
```
Customer
  │
  ├─▶ Consent Current (TCPA, CAN-SPAM, GDPR)
  │     │
  │     └─▶ Suppression List (global opt-out)
  │
  └─▶ Lead (consent-validated)
        │
        └─▶ Campaign (compliance-approved)
              │
              └─▶ Communication (compliant)
```

## Expected Relationships Count

**Silver Layer Total**: ~25-30 relationships

### By Table:
1. **mktg_campaigns_enriched**: 2 outbound (product, offer)
2. **mktg_leads_enriched**: 4 outbound (customer, campaign, product, offer)
3. **mktg_customer_journeys**: 3 outbound (customer, lead, campaign)
4. **mktg_multi_touch_attribution**: 3 outbound (customer, journey, campaign)
5. **mktg_campaign_performance_daily**: 1 outbound (campaign)
6. **mktg_offer_performance**: 2 outbound (offer, campaign)
7. **mktg_consent_current**: 1 outbound (customer)
8. **mktg_product_line_performance**: 0 (aggregation table)

**Platform Tables**: ~10 additional relationships (email → campaigns, paid search → campaigns, etc.)

## Visual Representation in Physical ERD

The Physical ERD will now show:

### Node Types:
- **Blue nodes**: Banking-specific tables (8 tables)
- **Gray nodes**: Platform tables (18 tables)

### Relationship Lines:
- **Solid lines**: Direct FK relationships
- **Line labels**: Show FK column names (campaign_id, customer_id, etc.)
- **Arrow direction**: From child (FK) to parent (PK)

### Key Relationship Clusters:

**1. Campaign Cluster** (center):
- Campaigns surrounded by: Leads, Journeys, Attribution, Performance, Offers

**2. Customer Cluster** (right):
- Customer connected to: Leads, Journeys, Attribution, Consent

**3. Compliance Cluster** (top-right):
- Consent connected to: Customer, Leads

**4. Performance Cluster** (bottom):
- Campaign Performance, Offer Performance connected to: Campaigns

## Business Value of These Relationships

### 1. Lead Attribution Chain
**Path**: Campaign → Lead → Journey → Attribution → Revenue  
**Business Question**: Which campaigns generate the highest-value leads?

### 2. Compliance Validation
**Path**: Customer → Consent → Lead → Campaign  
**Business Question**: Are we only contacting customers with valid TCPA consent?

### 3. Offer Effectiveness
**Path**: Campaign → Offer → Performance → Redemption Rate  
**Business Question**: Which $200 bonus offers have the best redemption rates?

### 4. Multi-Touch ROI
**Path**: Campaign → Journey → Attribution → Revenue  
**Business Question**: What's the true ROI including branch attribution?

### 5. Customer Journey Analysis
**Path**: Lead → Journey → Touchpoints → Conversion  
**Business Question**: How many touchpoints does it take to convert a personal loan lead?

### 6. Product Performance
**Path**: Campaign → Product → Performance → ROI  
**Business Question**: Which banking products have the best marketing ROI?

## Verification

### How to Verify Relationships are Showing

1. Navigate to Marketing-Retail domain
2. Click **Data Models** tab
3. Scroll to **Physical Data Model**
4. Click **Silver Layer** tab
5. Look for **relationship lines** connecting tables
6. Should see ~25-30 relationship lines
7. Hover over lines to see FK details
8. Key relationships to verify:
   - ✅ mktg_leads_enriched → mktg_campaigns_enriched
   - ✅ mktg_customer_journeys → mktg_leads_enriched
   - ✅ mktg_multi_touch_attribution → mktg_customer_journeys
   - ✅ mktg_leads_enriched → mktg_consent_current
   - ✅ mktg_campaign_performance_daily → mktg_campaigns_enriched

## Technical Details

### key_fields Arrays Added

```typescript
// Example: mktg_leads_enriched
key_fields: ['lead_id', 'customer_id', 'campaign_id', 'product_sku_interest', 'offer_id']
//           └─ PK      └─ FK 1       └─ FK 2        └─ FK 3                  └─ FK 4
```

The relationship detection function (`generateLayerRelationships`) will:
1. Extract `key_fields` from each table
2. Identify fields ending in `_id` or `_key` as potential FKs
3. Match FK field names to PK field names in other tables
4. Generate relationships where matches are found

### Relationship Object Structure

```typescript
{
  from: 'silver.mktg_leads_enriched',
  to: 'silver.mktg_campaigns_enriched',
  fromColumn: 'campaign_id',
  toColumn: 'campaign_id',
}
```

## Status

✅ **COMPLETE**: All 8 banking-specific Silver Layer tables have `key_fields` defined  
✅ **READY**: Relationships will be auto-detected by evaluation function  
✅ **VISIBLE**: Physical ERD will display ~25-30 relationship lines  
✅ **MEANINGFUL**: Relationships reflect real banking use case flows
